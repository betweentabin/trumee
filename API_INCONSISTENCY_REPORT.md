# フロントエンド・バックエンド API不整合調査報告書

## 概要
フロントエンドとバックエンドのAPIリクエストに複数の不整合が確認され、アプリケーションの各機能に障害が発生しています。
本報告書では、検出された不整合を重要度別に分類し、修正方針を提案します。

## 1. システム構成

### フロントエンド
- **APIバージョン**: v2 (`/api/v2/`)
- **設定ファイル**: `/frontend/config/api.ts`
- **APIクライアント**: 
  - 新: `/lib/api-v2-client.ts` (DRFトークン優先)
  - 旧: `/lib/api-client.ts` (混在使用)
- **認証形式**: Bearer トークン

### バックエンド
- **APIバージョン**: v1, v2 両対応
- **URL設定**: 
  - v1: `/back/core/urls_api.py`
  - v2: `/back/core/urls_api_v2.py`
- **認証**: DRF Token + JWT

## 2. 検出された不整合

### 🔴 重大な不整合

#### 1. プロフィールエンドポイントの不一致
| 項目 | フロントエンド期待値 | バックエンド実装 |
|------|---------------------|-----------------|
| エンドポイント | `/api/v2/user/profile/` | `/api/v2/profile/me/` |
| 影響 | ユーザープロフィール取得が完全に動作しない |
| 修正優先度 | **最高** |

**修正案**:
```typescript
// frontend/config/api.ts
userProfile: '/profile/me/',  // 修正
```

#### 2. 認証システムの混乱
| 問題点 | 詳細 |
|--------|------|
| APIクライアントの混在 | 新旧2つのクライアントが並存 |
| トークン管理の複雑化 | DRFトークンとJWTトークンの優先順位が不明確 |
| 影響 | 認証エラーが頻発、セッション管理が不安定 |

**現状の構造**:
```
フロントエンド
├── api-v2-client.ts (DRFトークン優先)
├── api-client.ts (旧実装、v1/v2混在)
└── useAuth.ts (旧APIクライアント使用)
```

### 🟡 中程度の不整合

#### 3. レスポンス形式の違い

**バックエンドレスポンス (登録/ログイン)**:
```json
{
  "message": "Login successful",
  "user": {...},
  "token": "jwt_access_token",
  "drf_token": "drf_token_key"
}
```

**フロントエンド期待値 (useAuth.ts)**:
```json
{
  "tokens": {
    "access": "jwt_access_token",
    "refresh": "jwt_refresh_token"
  },
  "user": {...}
}
```

#### 4. 企業登録時のデータ変換問題

| フィールド | フロントエンド送信値 | バックエンド解釈 | 問題 |
|-----------|-------------------|----------------|------|
| capital | 従業員数カテゴリの数値 | 資本金 | データの意味が異なる |
| first_name/last_name | 代表者名から分割 | 正常受信 | - |

### 🟢 軽微な不整合

#### 5. 未実装エンドポイント

| エンドポイント | フロントエンド定義 | バックエンド | 状態 |
|--------------|------------------|------------|------|
| `/auth/logout/` | ✓ | ✗ | 未実装 |
| `/auth/token/refresh/` | ✓ | ✗ | 未実装 |
| `/auth/token/verify/` | ✓ | ✗ | 未実装 |

## 3. 影響を受ける機能

### 機能別影響度マトリクス

| 機能 | 影響度 | 原因となる不整合 |
|------|--------|----------------|
| ユーザープロフィール表示 | **動作不可** | プロフィールエンドポイント不一致 |
| ログイン/ログアウト | **部分的に動作** | レスポンス形式、認証システムの混乱 |
| ユーザー登録 | **不安定** | レスポンス形式の違い |
| 企業登録 | **不安定** | データ変換問題、レスポンス形式 |
| 求人検索・応募 | **影響あり** | 認証システムの混乱 |
| スカウト機能 | **影響あり** | 認証システムの混乱 |

## 4. 修正計画

### Phase 1: 緊急修正（1-2日）
1. **プロフィールエンドポイントの修正**
   - [ ] `frontend/config/api.ts`の`userProfile`を`/profile/me/`に変更
   - [ ] 関連コンポーネントのテスト

2. **認証レスポンス形式の統一**
   - [ ] バックエンドレスポンスを`tokens`オブジェクト形式に変更
   - [ ] または、フロントエンドの期待値を新形式に合わせる

### Phase 2: 重要修正（3-5日）
1. **APIクライアントの統一**
   - [ ] api-v2-client.tsに完全移行
   - [ ] useAuth.tsの更新
   - [ ] 旧api-client.tsの段階的廃止

2. **企業登録データ構造の見直し**
   - [ ] 資本金と従業員数フィールドの明確化
   - [ ] フロントエンドフォームの修正

### Phase 3: 改善（1週間以降）
1. **未実装エンドポイントの追加**
   - [ ] ログアウトAPI実装
   - [ ] トークンリフレッシュ機能
   - [ ] トークン検証エンドポイント

2. **型安全性の向上**
   - [ ] TypeScript型定義の更新
   - [ ] APIレスポンス型の自動生成

## 5. 推奨事項

### 即時対応が必要な項目
1. プロフィールエンドポイントの修正（5分で修正可能）
2. 認証トークンの処理統一

### 中期的な改善項目
1. APIバージョニング戦略の見直し
2. エラーハンドリングの統一
3. APIドキュメントの作成

### 長期的な改善項目
1. GraphQLやtRPCなど型安全なAPI層の導入検討
2. E2Eテストの充実
3. CI/CDパイプラインでのAPI整合性チェック

## 6. テスト項目

修正後に確認すべき主要機能:
- [ ] ユーザー登録フロー
- [ ] 企業登録フロー
- [ ] ログイン/ログアウト
- [ ] プロフィール表示・編集
- [ ] 求人検索・応募
- [ ] スカウト送受信
- [ ] 履歴書作成・編集

## 付録: API一覧

### 認証関連API
| 機能 | フロントエンド期待 | バックエンド実装 | 状態 |
|------|------------------|-----------------|------|
| ユーザー登録 | `/api/v2/auth/register-user/` | `/api/v2/auth/register-user/` | ✓ |
| 企業登録 | `/api/v2/auth/register-company/` | `/api/v2/auth/register-company/` | ✓ |
| ログイン | `/api/v2/auth/login/` | `/api/v2/auth/login/` | ✓ |
| ログアウト | `/api/v2/auth/logout/` | - | ✗ |

### プロフィール関連API
| 機能 | フロントエンド期待 | バックエンド実装 | 状態 |
|------|------------------|-----------------|------|
| ユーザープロフィール | `/api/v2/user/profile/` | `/api/v2/profile/me/` | ✗ |
| 求職者プロフィール一覧 | `/api/v2/seeker-profiles/` | `/api/v2/seeker-profiles/` | ✓ |
| 企業プロフィール一覧 | `/api/v2/company-profiles/` | `/api/v2/company-profiles/` | ✓ |

### その他主要API
| 機能 | フロントエンド期待 | バックエンド実装 | 状態 |
|------|------------------|-----------------|------|
| 履歴書 | `/api/v2/resumes/` | `/api/v2/resumes/` | ✓ |
| 求人 | `/api/v2/jobs/` | `/api/v2/jobs/` | ✓ |
| 応募 | `/api/v2/applications/` | `/api/v2/applications/` | ✓ |
| スカウト | `/api/v2/scouts/` | `/api/v2/scouts/` | ✓ |

---
*最終更新: 2025年8月31日*